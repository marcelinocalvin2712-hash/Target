<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nerf Smart Detector</title>
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; margin: 0; text-align: center; overflow: hidden; }
        
        .ui-panel { background: #1e293b; padding: 10px; border-bottom: 2px solid #334155; }
        .score { font-size: 48px; font-weight: 900; color: #fbbf24; margin: 0; }
        
        #viewport { position: relative; width: 100vw; height: 50vh; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { display: none; }

        #target-box {
            position: absolute; top: 50%; left: 50%;
            width: 120px; height: 120px;
            transform: translate(-50%, -50%);
            border: 4px solid #38bdf8;
            border-radius: 10px;
            z-index: 10;
        }

        .settings { 
            padding: 15px; background: #1e293b; 
            display: flex; flex-direction: column; gap: 10px;
            font-size: 14px;
        }
        .row { display: flex; justify-content: space-around; align-items: center; }
        
        input[type="color"] { border: none; width: 40px; height: 40px; cursor: pointer; background: none; }
        input[type="range"] { width: 60%; }
        
        button { 
            padding: 12px 30px; background: #38bdf8; color: #0f172a; 
            border: none; border-radius: 25px; font-weight: bold; font-size: 16px;
        }
        #status { font-size: 12px; color: #94a3b8; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="ui-panel">
        <div class="score" id="score-val">0</div>
        <div id="status">PILIH WARNA & TEKAN START</div>
    </div>

    <div id="viewport">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="proc-canvas"></canvas>
        <div id="target-box"></div>
    </div>

    <div class="settings">
        <div class="row">
            <div>
                <label>Warna Peluru:</label><br>
                <input type="color" id="color-target" value="#ff6600">
            </div>
            <div style="flex-grow: 1;">
                <label>Sensitivitas Gerak: <span id="sens-val">20</span></label><br>
                <input type="range" id="sens-slider" min="5" max="100" value="20">
            </div>
        </div>
        
        <div class="row">
            <button id="start-btn" onclick="startApp()">START SENSOR</button>
            <button onclick="resetScore()" style="background:#475569; color:white;">RESET</button>
        </div>
    </div>

    <audio id="hit-sound" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('proc-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const scoreDisplay = document.getElementById('score-val');
        const statusDisplay = document.getElementById('status');
        const hitSound = document.getElementById('hit-sound');
        
        // UI Elements
        const colorInput = document.getElementById('color-target');
        const sensSlider = document.getElementById('sens-slider');
        const sensLabel = document.getElementById('sens-val');

        let score = 0;
        let lastFrameData = null;
        let isReady = false;
        let cooldown = false;

        sensSlider.oninput = () => sensLabel.innerText = sensSlider.value;

        // Konversi Hex ke RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        async function startApp() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment", frameRate: { ideal: 60 } }
                });
                video.srcObject = stream;
                hitSound.play().then(() => { hitSound.pause(); hitSound.currentTime = 0; });
                
                document.getElementById('start-btn').innerText = "RUNNING...";
                statusDisplay.innerText = "SENSOR AKTIF";
                
                canvas.width = 160;
                canvas.height = 120;
                isReady = true;
                requestAnimationFrame(processFrame);
            } catch (err) {
                alert("Kamera gagal diakses.");
            }
        }

        function processFrame() {
            if (!isReady) return;

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const roiX = 60, roiY = 40, roiW = 40, roiH = 40;
            const currentFrame = ctx.getImageData(roiX, roiY, roiW, roiH);
            const targetRGB = hexToRgb(colorInput.value);
            const tolerance = 70; // Toleransi warna agar tidak terlalu kaku

            if (lastFrameData && !cooldown) {
                let matchCount = 0;

                for (let i = 0; i < currentFrame.data.length; i += 4) {
                    const r = currentFrame.data[i];
                    const g = currentFrame.data[i+1];
                    const b = currentFrame.data[i+2];

                    // 1. Filter Warna: Cek apakah piksel ini warnanya mirip target
                    const colorMatch = Math.abs(r - targetRGB.r) < tolerance &&
                                       Math.abs(g - targetRGB.g) < tolerance &&
                                       Math.abs(b - targetRGB.b) < tolerance;

                    if (colorMatch) {
                        // 2. Filter Gerakan: Cek apakah piksel ini berubah dari frame sebelumnya
                        const diff = Math.abs(r - lastFrameData.data[i]) +
                                     Math.abs(g - lastFrameData.data[i+1]) +
                                     Math.abs(b - lastFrameData.data[i+2]);
                        
                        if (diff > 50) { 
                            matchCount++;
                        }
                    }
                }

                // Gunakan nilai slider untuk ambang batas deteksi
                if (matchCount > parseInt(sensSlider.value)) { 
                    triggerHit();
                }
            }

            lastFrameData = currentFrame;
            requestAnimationFrame(processFrame);
        }

        function triggerHit() {
            cooldown = true;
            score += 10;
            scoreDisplay.innerText = score;
            hitSound.currentTime = 0;
            hitSound.play();

            document.getElementById('target-box').style.borderColor = "#2ecc71";
            
            setTimeout(() => {
                cooldown = false;
                document.getElementById('target-box').style.borderColor = "#38bdf8";
            }, 1000);
        }

        function resetScore() {
            score = 0;
            scoreDisplay.innerText = score;
        }
    </script>
</body>
</html>